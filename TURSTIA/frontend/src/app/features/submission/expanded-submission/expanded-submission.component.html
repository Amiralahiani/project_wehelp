<!-- frontend/src/app/features/submission/expanded-submission/expanded-submission.component.html -->

<div class="container">
  <div class="form-header">
    <h1>üè¶ Formulaire de D√©briefing ‚Äì Demande de Cr√©dit</h1>
    <p class="subtitle">Rempli automatiquement + compl√©t√© et valid√© par l'agent</p>
  </div>

  <form #extendedForm="ngForm" (ngSubmit)="onSubmit()" *ngIf="!result">

    <!-- 1Ô∏è‚É£ M√âTADONN√âES DE L'INTERACTION -->
    <section class="form-section">
      <h2>1Ô∏è‚É£ M√©tadonn√©es de l'Interaction</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Canal de contact *</label>
          <select [(ngModel)]="formData.interaction_metadata!.contact_channel" name="contact_channel" required>
            <option value="PHONE_CALL">‚òéÔ∏è Appel t√©l√©phonique</option>
            <option value="EMAIL">üìß Email</option>
            <option value="SMS_WHATSAPP">üí¨ SMS / WhatsApp</option>
            <option value="PHYSICAL_MEETING">üë§ Rendez-vous physique</option>
          </select>
        </div>

        <div class="form-group">
          <label>Dur√©e de l'√©change (minutes)</label>
          <input type="number" [(ngModel)]="formData.interaction_metadata!.duration_minutes" name="duration" min="0">
        </div>
      </div>

      <div class="form-group">
        <label>Agent responsable</label>
        <input type="text" [(ngModel)]="formData.interaction_metadata!.agent_responsible" name="agent">
      </div>
    </section>

    <!-- 2Ô∏è‚É£ IDENTIFICATION DU CLIENT -->
    <section class="form-section">
      <h2>2Ô∏è‚É£ Identification du Client</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Nom / Pr√©nom</label>
          <input type="text" [(ngModel)]="formData.client_identity!.full_name" name="full_name"
            placeholder="Confidentiel">
        </div>

        <div class="form-group">
          <label>√Çge *</label>
          <input type="number" [(ngModel)]="formData.client_identity!.age" name="age" min="18" max="100" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Statut client *</label>
          <select [(ngModel)]="formData.client_identity!.client_status" name="client_status" required>
            <option value="REGULAR">Client r√©gulier</option>
            <option value="OCCASIONAL">Client occasionnel</option>
            <option value="NEW">Nouveau client</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fr√©quence des interactions *</label>
          <select [(ngModel)]="formData.client_identity!.interaction_frequency" name="interaction_freq" required>
            <option value="RARE">Rare</option>
            <option value="MEDIUM">Moyenne</option>
            <option value="FREQUENT">Fr√©quente</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Anciennet√© bancaire (ann√©es)</label>
        <input type="number" [(ngModel)]="formData.client_identity!.banking_seniority_years" name="seniority" min="0"
          step="0.5">
      </div>
    </section>

    <!-- 3Ô∏è‚É£ SITUATION PERSONNELLE & FAMILIALE -->
    <section class="form-section">
      <h2>3Ô∏è‚É£ Situation Personnelle & Familiale</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Situation matrimoniale *</label>
          <select [(ngModel)]="formData.personal_situation!.marital_status" name="marital_status" required>
            <option value="SINGLE">C√©libataire</option>
            <option value="MARRIED">Mari√©(e)</option>
            <option value="DIVORCED">Divorc√©(e)</option>
            <option value="WIDOWED">Veuf(ve)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Nombre de personnes √† charge *</label>
          <input type="number" [(ngModel)]="formData.personal_situation!.dependents_count" name="dependents" min="0"
            required>
        </div>
      </div>

      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" [(ngModel)]="formData.personal_situation!.spouse_exists" name="spouse_exists"
            (change)="onSpouseExistsChange()">
          Conjoint existant
        </label>
      </div>

      <div *ngIf="formData.personal_situation!.spouse_exists" class="subsection">
        <h3>Informations du conjoint</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Statut professionnel du conjoint *</label>
            <select [(ngModel)]="formData.personal_situation!.spouse_info!.professional_status" name="spouse_status">
              <option value="EMPLOYED">Employ√©</option>
              <option value="SELF_EMPLOYED">Ind√©pendant</option>
              <option value="UNEMPLOYED">Sans emploi</option>
            </select>
          </div>

          <div class="form-group">
            <label>Revenu mensuel du conjoint (‚Ç¨)</label>
            <input type="number" [(ngModel)]="formData.personal_situation!.spouse_info!.monthly_income"
              name="spouse_income" min="0">
          </div>
        </div>
      </div>
    </section>

    <!-- 4Ô∏è‚É£ SITUATION PROFESSIONNELLE DU CLIENT -->
    <section class="form-section">
      <h2>4Ô∏è‚É£ Situation Professionnelle du Client</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Statut professionnel *</label>
          <select [(ngModel)]="formData.professional_situation!.professional_status" name="prof_status" required>
            <option value="EMPLOYEE_CDI">Salari√© CDI</option>
            <option value="EMPLOYEE_CDD">Salari√© CDD</option>
            <option value="SELF_EMPLOYED">Ind√©pendant</option>
            <option value="ENTREPRENEUR">Entrepreneur</option>
            <option value="UNEMPLOYED">Sans emploi</option>
          </select>
        </div>

        <div class="form-group">
          <label>Secteur d'activit√©</label>
          <input type="text" [(ngModel)]="formData.professional_situation!.sector" name="sector">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Anciennet√© professionnelle (ann√©es)</label>
          <input type="number" [(ngModel)]="formData.professional_situation!.seniority_years" name="prof_seniority"
            min="0" step="0.5">
        </div>

        <div class="form-group">
          <label>Stabilit√© professionnelle *</label>
          <select [(ngModel)]="formData.professional_situation!.stability" name="stability" required>
            <option value="LOW">Faible</option>
            <option value="MEDIUM">Moyenne</option>
            <option value="HIGH">√âlev√©e</option>
          </select>
        </div>
      </div>
    </section>

    <!-- 5Ô∏è‚É£ SITUATION FINANCI√àRE -->
    <section class="form-section">
      <h2>5Ô∏è‚É£ Situation Financi√®re</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Revenu mensuel net (‚Ç¨) *</label>
          <input type="number" [(ngModel)]="formData.financial_situation!.monthly_income_net" name="income" min="0"
            required (change)="calculateDebtRatio()">
        </div>

        <div class="form-group">
          <label>Charges mensuelles fixes (‚Ç¨) *</label>
          <input type="number" [(ngModel)]="formData.financial_situation!.monthly_fixed_expenses" name="expenses"
            min="0" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Cr√©dits en cours - Montant total (‚Ç¨)</label>
          <input type="number" [(ngModel)]="formData.financial_situation!.existing_credits_total" name="credits_total"
            min="0">
        </div>

        <div class="form-group">
          <label>Mensualit√©s cumul√©es (‚Ç¨)</label>
          <input type="number" [(ngModel)]="formData.financial_situation!.existing_credits_monthly_payment"
            name="credits_monthly" min="0" (change)="calculateDebtRatio()">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Taux d'endettement (%)</label>
          <input type="number" [value]="(formData.financial_situation!.debt_ratio || 0) * 100" readonly disabled
            class="readonly">
        </div>

        <div class="form-group">
          <label>√âpargne disponible (‚Ç¨)</label>
          <input type="number" [(ngModel)]="formData.financial_situation!.available_savings" name="savings" min="0">
        </div>
      </div>

      <div class="form-group">
        <label>Historique bancaire *</label>
        <select [(ngModel)]="formData.financial_situation!.banking_history" name="banking_history" required>
          <option value="NO_INCIDENT">Aucun incident</option>
          <option value="MINOR_INCIDENTS">Incidents mineurs</option>
          <option value="MAJOR_INCIDENTS">Incidents majeurs</option>
        </select>
      </div>
    </section>

    <!-- 6Ô∏è‚É£ DEMANDE DE CR√âDIT -->
    <section class="form-section">
      <h2>6Ô∏è‚É£ Demande de Cr√©dit</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Type de cr√©dit *</label>
          <select [(ngModel)]="formData.credit_request!.credit_type" name="credit_type" required>
            <option value="REAL_ESTATE">Immobilier</option>
            <option value="PERSONAL">Personnel</option>
            <option value="AUTO">Auto</option>
            <option value="PROFESSIONAL">Professionnel</option>
          </select>
        </div>

        <div class="form-group">
          <label>Objet du cr√©dit *</label>
          <select [(ngModel)]="formData.credit_request!.purpose" name="purpose" required>
            <option value="INVESTMENT">Investissement</option>
            <option value="NECESSARY_EXPENSE">D√©pense n√©cessaire</option>
            <option value="COMFORT_EXPENSE">D√©pense de confort</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Montant demand√© (‚Ç¨) *</label>
          <input type="number" [(ngModel)]="formData.credit_request!.amount_requested" name="amount" min="0" required>
        </div>

        <div class="form-group">
          <label>Dur√©e souhait√©e (mois) *</label>
          <input type="number" [(ngModel)]="formData.credit_request!.duration_months" name="duration_months" min="1"
            required>
        </div>
      </div>
    </section>

    <!-- 7Ô∏è‚É£ INDICATEURS COMPORTEMENTAUX -->
    <section class="form-section">
      <h2>7Ô∏è‚É£ Indicateurs Comportementaux</h2>
      <p class="section-note">Observations structur√©es par l'agent</p>

      <div class="form-group">
        <label>Niveau de stress (1=Tr√®s calme, 5=Tr√®s stress√©) *</label>
        <div class="radio-group">
          <label *ngFor="let i of [1,2,3,4,5]">
            <input type="radio" [(ngModel)]="formData.behavioral_indicators!.stress_level" [value]="i" name="stress"
              required> {{i}}
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>Niveau d'urgence (1=Non urgent, 5=Extr√™mement urgent) *</label>
        <div class="radio-group">
          <label *ngFor="let i of [1,2,3,4,5]">
            <input type="radio" [(ngModel)]="formData.behavioral_indicators!.urgency_level" [value]="i" name="urgency"
              required> {{i}}
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>Clart√© du projet (1=Tr√®s flou, 5=Tr√®s structur√©) *</label>
        <div class="radio-group">
          <label *ngFor="let i of [1,2,3,4,5]">
            <input type="radio" [(ngModel)]="formData.behavioral_indicators!.project_clarity" [value]="i" name="clarity"
              required> {{i}}
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>Engagement per√ßu (1=Faible, 5=Tr√®s √©lev√©) *</label>
        <div class="radio-group">
          <label *ngFor="let i of [1,2,3,4,5]">
            <input type="radio" [(ngModel)]="formData.behavioral_indicators!.engagement_level" [value]="i"
              name="engagement" required> {{i}}
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>Coh√©rence discours ‚Üî situation *</label>
        <select [(ngModel)]="formData.behavioral_indicators!.discourse_coherence" name="coherence" required>
          <option value="LOW">Faible</option>
          <option value="MEDIUM">Moyenne</option>
          <option value="HIGH">√âlev√©e</option>
        </select>
      </div>
    </section>

    <!-- 8Ô∏è‚É£ INTENTION R√âELLE DU CLIENT -->
    <section class="form-section">
      <h2>8Ô∏è‚É£ Intention R√©elle du Client</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Motivation principale *</label>
          <select [(ngModel)]="formData.real_intention!.main_motivation" name="motivation" required>
            <option value="NECESSITY">N√©cessit√©</option>
            <option value="OPPORTUNITY">Opportunit√©</option>
            <option value="EXTERNAL_PRESSURE">Pression externe</option>
          </select>
        </div>

        <div class="form-group">
          <label>Capacit√© de projection *</label>
          <select [(ngModel)]="formData.real_intention!.projection_capacity" name="projection" required>
            <option value="SHORT_TERM_ONLY">Court terme uniquement</option>
            <option value="MEDIUM_TERM">Moyen terme</option>
            <option value="LONG_TERM">Long terme</option>
          </select>
        </div>
      </div>
    </section>

    <!-- 9Ô∏è‚É£ RISQUES IDENTIFI√âS -->
    <section class="form-section">
      <h2>9Ô∏è‚É£ Risques Identifi√©s</h2>
      <p class="section-note">Checklist agent</p>

      <div class="checkbox-list">
        <label>
          <input type="checkbox" [(ngModel)]="formData.risk_checklist!.professional_instability" name="risk1">
          Instabilit√© professionnelle
        </label>
        <label>
          <input type="checkbox" [(ngModel)]="formData.risk_checklist!.high_debt" name="risk2">
          Endettement √©lev√©
        </label>
        <label>
          <input type="checkbox" [(ngModel)]="formData.risk_checklist!.spouse_income_dependency" name="risk3">
          D√©pendance au revenu du conjoint
        </label>
        <label>
          <input type="checkbox" [(ngModel)]="formData.risk_checklist!.non_priority_project" name="risk4">
          Projet non prioritaire
        </label>
        <label>
          <input type="checkbox" [(ngModel)]="formData.risk_checklist!.excessive_urgency" name="risk5">
          Urgence excessive
        </label>
        <label>
          <input type="checkbox" [(ngModel)]="formData.risk_checklist!.incoherent_discourse" name="risk6">
          Discours incoh√©rent
        </label>
      </div>
    </section>

    <!-- üîü PI√àCES JUSTIFICATIVES (Pour Qdrant/RAG) -->
    <section class="form-section">
      <h2>üîü Pi√®ces Justificatives (RAG Pipeline)</h2>
      <p class="section-note">Documents pour l'analyse de similarit√© et l'audit</p>

      <app-document-upload [submitted]="submitting" (documentsChange)="onDocumentsUpdate($event)">
      </app-document-upload>
    </section>

    <!-- 1Ô∏è‚É£1Ô∏è‚É£ SYNTH√àSE STRUCTUR√âE ‚Äì IA READY -->
    <section class="form-section">
      <h2>1Ô∏è‚É£1Ô∏è‚É£ Synth√®se Structur√©e ‚Äì IA Ready</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Profil de risque global *</label>
          <select [(ngModel)]="formData.synthesis!.global_risk_profile" name="risk_profile" required>
            <option value="LOW">Faible</option>
            <option value="MEDIUM">Moyen</option>
            <option value="HIGH">√âlev√©</option>
          </select>
        </div>

        <div class="form-group">
          <label>Capacit√© th√©orique de remboursement *</label>
          <select [(ngModel)]="formData.synthesis!.theoretical_repayment_capacity" name="repayment" required>
            <option value="INSUFFICIENT">Insuffisante</option>
            <option value="ACCEPTABLE">Acceptable</option>
            <option value="SOLID">Solide</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Submit Button -->
    <div class="form-actions">
      <button type="submit" class="btn-primary" [disabled]="!extendedForm.valid || submitting">
        {{ submitting ? '‚è≥ Traitement en cours...' : '‚úÖ Soumettre la demande' }}
      </button>
      <button type="button" class="btn-secondary" (click)="resetForm()" *ngIf="!submitting">
        üîÑ R√©initialiser
      </button>
    </div>

    <div class="error-message" *ngIf="error">
      ‚ùå {{ error }}
    </div>
  </form>

  <!-- Result Display -->
  <div class="result-display" *ngIf="result">
    <h2>‚úÖ R√©sultat de l'√âvaluation</h2>

    <div class="result-summary" *ngIf="result.evaluation_result">
      <div class="decision-main-badge" [attr.data-decision]="result.evaluation_result.final_decision">
        {{ result.evaluation_result.final_decision }}
      </div>
      <div class="manual-review-badge" *ngIf="result.evaluation_result.mode === 'MANUAL_REVIEW_REQUIRED'">
        ‚ö†Ô∏è EXAMEN MANUEL REQUIS
      </div>
      <p class="reason">{{ result.evaluation_result.reason }}</p>
    </div>

    <app-risk-comparison-panel *ngIf="result.evaluation_result?.risk_comparison"
      [riskComparison]="result.evaluation_result.risk_comparison">
    </app-risk-comparison-panel>

    <!-- üìä EXTRACTION DOCUMENTAIRE (Signaux OCR) -->
    <div class="ocr-results" *ngIf="result.evaluation_result?.document_signals?.documents_count > 0">
      <h3>üîç V√©rification Documentaire (Signaux OCR)</h3>
      <div class="signals-grid">
        <div class="signal-card" *ngIf="result.evaluation_result.document_signals.detected_income">
          <span class="label">Revenu d√©tect√©:</span>
          <span class="value">{{ result.evaluation_result.document_signals.detected_income |
            currency:'EUR':'symbol':'1.0-0' }}</span>
        </div>
        <div class="signal-card" *ngIf="result.evaluation_result.document_signals.employment_type">
          <span class="label">Type d'emploi:</span>
          <span class="value">{{ result.evaluation_result.document_signals.employment_type }}</span>
        </div>
        <div class="signal-card" *ngIf="result.evaluation_result.document_signals.sector">
          <span class="label">Secteur:</span>
          <span class="value">{{ result.evaluation_result.document_signals.sector }}</span>
        </div>
        <div class="signal-card" *ngIf="result.evaluation_result.document_signals.late_payments">
          <span class="label" style="color: #e11d48;">Incidents d√©tect√©s:</span>
          <span class="value" style="color: #e11d48;">{{ result.evaluation_result.document_signals.late_payments
            }}</span>
        </div>
      </div>
    </div>

    <div class="result-content" *ngIf="!result.evaluation_result?.risk_comparison">
      <pre>{{ result | json }}</pre>
    </div>
    <button class="btn-primary" (click)="resetForm()">
      ‚ûï Nouvelle demande
    </button>
  </div>
</div>